#!/bin/bash

#vi ./content/posts/hello-blog.md

# Ask for the title of the post
read -rp "Post Title: " TITLE

# Generate slug from TITLE
SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9 ]//g; s/ /-/g')

POST_PATH="content/posts/${SLUG}.md"

# Test if post title exists already
if [ -f $FILE ]; then
   echo "Post ${$SLUG} exists already, choose another title."
   exit 1
fi

# Create new post using hugo
hugo new content '$POST_PATH'


# Change the frontmatter to include 
# - author = Podepod
# - tldr (empty)
# - tags (empty)
TMP_FM="$(mktemp)"

# cleanup temp file on script exit
tmp_fm_cleanup() {
  [[ -f "TMP_FM" ]] && rm -f "$TMP_FM"
}

trap tmp_fm_cleanup EXIT INT TERM

cat > "$TMP_FM" <<EOF
+++
title = '$TITLE'
author = 'Podepod'
date = '$(date -u +"%Y-%m-%dT%H:%M:%SZ")'
tldr = ''
tags = []
toc = false
draft = true
+++
EOF

# Review the generated frontmatter
vim "$TMP_FM"

echo "-----------------------------------------------------------------"
echo "Post Title:   $TITLE"
echo "Post Slug:    $SLUG"
echo "Post Path:    $POST_PATH"
echo "Front matter: "
echo
cat $TMP_FM
echo
echo "-----------------------------------------------------------------"

echo
read -rp "Apply this frontmatter to the post? [y/N] " CONFIRM
[[ "$CONFIRM" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }

# Replace the file generated by Hugo with the new frontmatter
mv "$TMP_FM" "$POST_PATH"

# Open the post file with vim
vim "$POST_PATH"
